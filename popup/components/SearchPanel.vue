<template>
  <div id="searchPanel">
    <div>
      <v-text-field
        solo
        :placeholder="$i18n('Search_label')"
        hide-details
        class="mb-3"
        id="searchBox"
        name="cc5704978dc0411591addc66d25c325b"
        :value="currentSearchTerm"
        :title="$i18n('Search_tip')"
        @input="onSearchInput"
        autofocus
        @keyup.arrow-down.stop.prevent="focusFirstResult"
        @keyup.enter.stop.prevent="focusFirstResult"
        @keyup.escape.stop.prevent="handleEscape"
      ></v-text-field>
      <!-- <input
        type="text"
        :placeholder="$i18n('Search_label')"
        id="searchBox"
        name="cc5704978dc0411591addc66d25c325b"
        class="form-control"
        :value="currentSearchTerm"
        :title="$i18n('Search_tip')"
        @input="onSearchInput"
        @keydown="searchBoxKeyboardNavHandler"
        autofocus
        @keyup.arrow-down.stop.prevent="focusFirstResult"
        @keyup.enter.stop.prevent="focusFirstResult"
        @keyup.escape.stop.prevent="handleEscape"
      >-->
    </div>
    <!-- <div id="searchResults"> -->
    <!-- <v-list v-show="searchResults && searchResults.length > 0" id="searchResults-Container"> -->
    <Entry
      v-for="(entry, index) of searchResults"
      :key="entry.uniqueID"
      :entry="entry"
      :index="index"
    ></Entry>
    <!-- </v-list> -->
    <!-- </div> -->
  </div>
</template>

<script lang="ts">
import { Component } from "vue";
import { mapState, mapActions, mapGetters, mapMutations } from "vuex";
import { names as actionNames } from "../../store/action-names";
import { SessionType } from "../../common/kfDataModel";
import { KeeState } from "../../store/KeeState";
import { ButtonAction } from "../../common/Button";
import { configManager } from "../../common/ConfigManager";
import { AddonMessage } from "../../common/AddonMessage";
import { Port } from "../../common/port";
import { Search, SearchResult } from "../../common/search";
import Entry from "./Entry.vue";
import { mTypes } from "../../store";

export default {
  created(this: any) {
    this.onDBChanged = () => {
      this.search = new Search(
        {
          KeePassDatabases: this.$store.getters.KeePassDatabases,
          ActiveKeePassDatabaseIndex: this.$store.getters
            .ActiveKeePassDatabaseIndex
        } as any,
        {
          version: 1,
          searchAllDatabases: configManager.current.searchAllOpenDBs,
          maximumResults: 50
        }
      );
    };
    this.onDBChanged();
  },
  data() {
    return {};
  },
  components: { Entry },

  mounted(this: any) {
    this.$store.subscribe((mutation, state) => {
      if (mutation.type === mTypes.updateKeePassDatabases) {
        this.onDBChanged();
      }
    });
  },
  computed: {
    ...mapGetters(["currentSearchTerm", "searchResults"])
  },

  methods: {
    ...mapActions(actionNames),
    onSearchComplete(logins: SearchResult[]) {
      console.log("onSearchComplete");
      logins = logins
        .sort(function(a, b) {
          if (a.relevanceScore > b.relevanceScore) return -1;
          if (a.relevanceScore < b.relevanceScore) return 1;
          return 0;
        })
        .map(l => Object.assign(l, { fullDetails: null }));
      (this as any).$store.dispatch("updateSearchResults", logins);
    },
    onSearchInput(value) {
      const pm = (this as any).postMessage;
      pm({ currentSearchTerm: value } as AddonMessage);

      // Think this is OK but if it is actually async then user may have subsequent
      // characters deleted when the change is actually applied
      (this as any).$store.dispatch(
        "updateCurrentSearchTerm",
        value
      );
      (this as any).search.execute(
        value,
        (this as any).onSearchComplete.bind(this),
        []
      );
    },
    focusFirstResult() {
      const searchResults = document.getElementById("searchResults-Container");
      if (searchResults && searchResults.firstElementChild) {
        (searchResults.firstElementChild as HTMLLIElement).focus();
      }
    },
    handleEscape() {
      // This does not work in Firefox due to https://bugzilla.mozilla.org/show_bug.cgi?id=1373175
      const searchBox = document.getElementById(
        "searchBox"
      ) as HTMLInputElement;
      if (searchBox.value) {
        searchBox.value = "";
        searchBox.dispatchEvent(new Event("input"));
      } else {
        window.close();
      }
    }
  },
  mixins: [Port.mixin]
};
</script>
