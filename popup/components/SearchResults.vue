<template>
  <div id="searchPanel" class="pb-4 pt-0 pr-0">
      <!-- <v-layout column justify-start align-top style="">
          <v-flex xs12 class="pb-4" style="">
            <div> -->
<v-divider v-show="filteredMatches && filteredMatches.length > 0"></v-divider>

    <!-- TODO: list all matched logins here and hook up the text box to filter them too. Also must filter 
    search results to exclude those that are listed here so we avoid duplicates -->

    
    <Entry
      v-for="(match, index) of filteredMatches"
      :key="match.entry.uniqueID"
      :entry="match.entry"
      :index="index"
      :frameId="frameId"
      :loginIndex="match.originalIndex"
    ></Entry>
    <!-- <Entry :show="true" :entry="entry"/>
    <Entry :show="false" :entry="entry"/>
    <Entry :show="true" :entry="entry"/> -->

<v-divider v-show="deduplicatedSearchResults && deduplicatedSearchResults.length > 0" class="mt-2"></v-divider>
            <v-subheader
              v-show="deduplicatedSearchResults && deduplicatedSearchResults.length > 0"
              class="text-xs-center"
              style="justify-content: center;"
            >Matches from other sites</v-subheader>

    <!-- <div id="searchResults"> -->
    <!-- <v-list v-show="searchResults && searchResults.length > 0" id="searchResults-Container"> -->
    <Entry
      v-for="(entry, index) of deduplicatedSearchResults"
      :key="entry.uniqueID"
      :entry="entry"
      :index="index"
    ></Entry>
    <!-- </v-list> -->
    <!-- </div>
          </v-flex>
      </v-layout> -->
  </div>
</template>

<script lang="ts">
import { Component } from "vue";
import { mapActions, mapGetters } from "vuex";
import { names as actionNames } from "../../store/action-names";
import { configManager } from "../../common/ConfigManager";
import { AddonMessage } from "../../common/AddonMessage";
import { Search, SearchResult, SearchOnlyMatches } from "../../common/search";
import Entry from "./Entry.vue";
import { mTypes } from "../../store";

export default {
  props: ['matchedLogins', 'frameId'],
  created(this: any) {
    if (this.matchedLogins) {
      for (let i=0; i < this.matchedLogins.length; i++) {
        this.uidMap.set(this.matchedLogins[i].uniqueID, i);
      }
    }
    this.searchOnlyMatches = new SearchOnlyMatches(this.matchedLogins);
    this.searchOnlyMatches.execute(this.currentSearchTerm, (this as any).onSearchOnlyMatchesComplete.bind(this));
  },
  data() {
    return {
      filteredMatches: null,
      uidMap: new Map<string, number>()
    };
  },
  components: { Entry },

  mounted(this: any) {
    this.$store.subscribe((mutation, state) => {
      // if (mutation.type === mTypes.updateKeePassDatabases) {
      //   this.onDBChanged();
      // }
      if (mutation.type === mTypes.updateCurrentSearchTerm) {
        this.searchOnlyMatches.execute(this.currentSearchTerm, (this as any).onSearchOnlyMatchesComplete.bind(this));
      }
    });
  },
  computed: {
    ...mapGetters(["currentSearchTerm", "searchResults"]),
    deduplicatedSearchResults: function (this: any) {
      if (this.searchResults) {
        if (this.matchedLogins) {
          return this.searchResults.filter(
            e => !this.matchedLogins.some(m => m.uniqueID === e.uniqueID));
        } else {
          return this.searchResults;
        }
      }
      return null;
    }
  },

  methods: {
    ...mapActions(actionNames),
    onSearchOnlyMatchesComplete(this: any, logins: SearchResult[]) {
      console.log("onSearchOnlyMatchesComplete");
      logins = logins
        .sort(function(a, b) {
          if (a.relevanceScore > b.relevanceScore) return -1;
          if (a.relevanceScore < b.relevanceScore) return 1;
          return 0;
        });
      this.filteredMatches = logins.map(m => ({
        entry: m,
        originalIndex: this.uidMap.get(m.uniqueID)
      }));
    },
  }
};
</script>

<style>
/* .search.v-text-field.v-text-field--solo .v-input__control {
  min-height: 36px !important;
} */
/* 
.theme--light.application #searchBoxContainer {
    background: #fafafa;
}

.theme--dark.application #searchBoxContainer {
  background: #303030;
}

.scrollable-contents {
  overflow-y: auto;
}

#searchPanel {
  max-height: inherit;
  height: inherit;
} */
</style>
